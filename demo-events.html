<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Events – Visitor tracking</title>
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --border: #2d3a4d;
      --text: #e6edf3;
      --muted: #8b949e;
      --accent: #58a6ff;
      --green: #3fb950;
      --orange: #d29922;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', monospace;
      font-size: 13px;
      line-height: 1.5;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .header {
      padding: 1rem 1.5rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .header h1 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
    }
    .header .meta {
      color: var(--muted);
      font-size: 12px;
    }
    .header label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--muted);
      cursor: pointer;
    }
    .header input[type="checkbox"] { accent-color: var(--accent); }
    .wrap {
      padding: 1rem 1.5rem;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td {
      padding: 0.6rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    th {
      font-weight: 600;
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    tr:hover td { background: rgba(255,255,255,0.02); }
    .col-sel { width: 2.5%; text-align: center; }
    .col-time { width: 10%; white-space: nowrap; }
    .col-visitor { width: 13%; overflow: hidden; text-overflow: ellipsis; }
    .col-type { width: 14%; }
    .col-details { width: 30%; }
    .col-utm { width: 18%; overflow: hidden; text-overflow: ellipsis; font-size: 11px; color: var(--muted); }
    .col-page { width: 22%; overflow: hidden; text-overflow: ellipsis; }
    .event-type {
      display: inline-block;
      padding: 0.15em 0.5em;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .event-type.click { background: #238636; color: #fff; }
    .event-type.form_open,
    .event-type.form_submit { background: #1f6feb; color: #fff; }
    .event-type.faq_open,
    .event-type.scope_open { background: #8957e5; color: #fff; }
    .event-type.modal_close,
    .event-type.video_modal_close { background: #9e6a03; color: #fff; }
    .event-type.menu_open,
    .event-type.menu_close { background: #6e7681; color: #fff; }
    .event-type.cal_link_click { background: #bf8700; color: #fff; }
    .event-type.time_on_site { background: #2d4; color: #000; }
    .event-type.video_play,
    .event-type.video_pause,
    .event-type.video_ended,
    .event-type.video_progress { background: #da3633; color: #fff; }
    .event-type.tc_open,
    .event-type.privacy_open { background: #6e7681; color: #fff; }
    .event-type.easter_egg_star { background: #db61a2; color: #fff; }
    .event-type.theme_switch { background: #6e7681; color: #fff; }
    .details {
      font-size: 12px;
      color: var(--muted);
    }
    .details span { margin-right: 0.75em; }
    .empty {
      padding: 3rem;
      text-align: center;
      color: var(--muted);
    }
    .error {
      padding: 1rem 1.5rem;
      background: rgba(248,81,73,0.1);
      color: #f85149;
      border-bottom: 1px solid var(--border);
    }
    .filters {
      padding: 0.75rem 1.5rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem 1rem;
    }
    .filters .label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-right: 0.25rem;
    }
    .filters label.filter {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 12px;
      color: var(--text);
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      background: var(--bg);
      border: 1px solid var(--border);
    }
    .filters label.filter:hover { border-color: var(--accent); }
    .filters label.filter input { accent-color: var(--accent); }
    .filters .search-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-left: auto;
    }
    .filters .search-wrap input {
      width: 220px;
      padding: 0.35rem 0.6rem;
      font: inherit;
      font-size: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
    }
    .filters .search-wrap input::placeholder { color: var(--muted); }
    .filters .search-wrap input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .header-actions { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .btn-delete {
      padding: 0.4rem 0.75rem;
      font: inherit;
      font-size: 12px;
      background: rgba(248, 81, 73, 0.2);
      color: #f85149;
      border: 1px solid rgba(248, 81, 73, 0.5);
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-delete:hover { background: rgba(248, 81, 73, 0.35); }
    .btn-delete:disabled { opacity: 0.4; cursor: not-allowed; }
    tbody input[type="checkbox"] { accent-color: var(--accent); cursor: pointer; }
  </style>
</head>
<body>
  <header class="header">
    <div>
      <h1>Visitor events</h1>
      <p class="meta">Live view · one row per event</p>
    </div>
    <div class="header-actions">
      <button type="button" class="btn-delete" id="deleteSelected" disabled title="Remove selected rows from view (reappear on next refresh)">Delete selected</button>
      <label>
        <input type="checkbox" id="live" checked>
        Auto-refresh every 5s
      </label>
    </div>
  </header>
  <div class="filters">
    <span class="label">Show:</span>
    <label class="filter"><input type="checkbox" name="filter" value="video" checked> Video</label>
    <label class="filter"><input type="checkbox" name="filter" value="form" checked> Form</label>
    <label class="filter"><input type="checkbox" name="filter" value="faq" checked> FAQ open</label>
    <label class="filter"><input type="checkbox" name="filter" value="scope" checked> Scope open</label>
    <label class="filter"><input type="checkbox" name="filter" value="time_on_site" checked> Time on site</label>
    <label class="filter"><input type="checkbox" name="filter" value="click" checked> Clicks</label>
    <label class="filter"><input type="checkbox" name="filter" value="modal" checked> Modal close</label>
    <label class="filter"><input type="checkbox" name="filter" value="menu" checked> Menu</label>
    <label class="filter"><input type="checkbox" name="filter" value="cal" checked> Calendar</label>
    <label class="filter"><input type="checkbox" name="filter" value="legal" checked> Legal</label>
    <label class="filter"><input type="checkbox" name="filter" value="easter_egg" checked> Easter egg</label>
    <label class="filter"><input type="checkbox" name="filter" value="theme" checked> Theme switch</label>
    <span class="search-wrap">
      <span class="label">UTM:</span>
      <input type="text" id="utmSearch" placeholder="e.g. lucy or google" autocomplete="off">
    </span>
    <span class="search-wrap">
      <span class="label">Email or visitor:</span>
      <input type="text" id="visitorSearch" placeholder="e.g. tom@example.com or v_abc123…" autocomplete="off">
    </span>
  </div>
  <div id="error" class="error" style="display:none"></div>
  <div class="wrap">
    <table>
      <thead>
        <tr>
          <th class="col-sel" title="Select all visible">
            <input type="checkbox" id="selectAll" title="Select all visible">
          </th>
          <th class="col-time">Time</th>
          <th class="col-visitor">Visitor (email or cookie)</th>
          <th class="col-type">Event</th>
          <th class="col-details">Details</th>
          <th class="col-utm">UTM</th>
          <th class="col-page">Page</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
    <p id="empty" class="empty" style="display:none">No events yet. Trigger some actions on the site to see them here.</p>
  </div>
  <script>
    (function () {
      var pathPrefix = window.location.pathname.replace(/\/[^/]*$/, '') || '';
      var API = (pathPrefix ? pathPrefix + '/' : '/') + 'api/analytics/events';
      var params = new URLSearchParams(window.location.search);
      var viewKey = params.get('view_key');
      if (viewKey) API += '?view_key=' + encodeURIComponent(viewKey);
      var liveCheck = document.getElementById('live');
      var tbody = document.getElementById('body');
      var emptyEl = document.getElementById('empty');
      var errEl = document.getElementById('error');
      var refreshTimer = null;
      var allEvents = [];

      var EVENT_GROUPS = {
        video: ['video_play', 'video_pause', 'video_ended', 'video_progress'],
        form: ['form_open', 'form_submit'],
        faq: ['faq_open'],
        scope: ['scope_open'],
        time_on_site: ['time_on_site'],
        click: ['click'],
        modal: ['modal_close', 'video_modal_close'],
        menu: ['menu_open', 'menu_close'],
        cal: ['cal_link_click'],
        legal: ['tc_open', 'privacy_open'],
        easter_egg: ['easter_egg_star'],
        theme: ['theme_switch']
      };

      function getSelectedFilters() {
        var selected = [];
        document.querySelectorAll('.filters input[name="filter"]:checked').forEach(function (cb) {
          selected.push(cb.value);
        });
        return selected;
      }

      function getVisitorSearch() {
        var el = document.getElementById('visitorSearch');
        return (el && el.value) ? el.value.trim() : '';
      }

      function getUtmSearch() {
        var el = document.getElementById('utmSearch');
        return (el && el.value) ? el.value.trim() : '';
      }

      function filterEvents(events) {
        if (!Array.isArray(events)) return [];
        var selected = getSelectedFilters();
        if (selected.length === 0) return [];
        var typesToShow = new Set();
        selected.forEach(function (group) {
          (EVENT_GROUPS[group] || []).forEach(function (t) { typesToShow.add(t); });
        });
        var byType = events.filter(function (e) { return typesToShow.has(e.event_type); });
        var visitorSearch = getVisitorSearch();
        if (visitorSearch) {
          visitorSearch = visitorSearch.toLowerCase();
          byType = byType.filter(function (e) {
            var email = (e.visitor_email || '').toLowerCase();
            var name = (e.visitor_name || '').toLowerCase();
            var id = (e.visitor_id || '').toLowerCase();
            return email.indexOf(visitorSearch) !== -1 || name.indexOf(visitorSearch) !== -1 || id.indexOf(visitorSearch) !== -1;
          });
        }
        var utmSearch = getUtmSearch();
        if (utmSearch) {
          utmSearch = utmSearch.toLowerCase();
          byType = byType.filter(function (e) {
            var src = (e.utm_source || '').toLowerCase();
            var med = (e.utm_medium || '').toLowerCase();
            var camp = (e.utm_campaign || '').toLowerCase();
            var term = (e.utm_term || '').toLowerCase();
            var content = (e.utm_content || '').toLowerCase();
            return src.indexOf(utmSearch) !== -1 || med.indexOf(utmSearch) !== -1 || camp.indexOf(utmSearch) !== -1 || term.indexOf(utmSearch) !== -1 || content.indexOf(utmSearch) !== -1;
          });
        }
        return byType;
      }

      function formatUtm(e) {
        var parts = [];
        if (e.utm_source) parts.push(e.utm_source);
        if (e.utm_medium) parts.push(e.utm_medium);
        if (e.utm_campaign) parts.push(e.utm_campaign);
        if (e.utm_term) parts.push(e.utm_term);
        if (e.utm_content) parts.push(e.utm_content);
        if (parts.length === 0) return '—';
        var s = parts.join(' · ');
        return s.length > 45 ? s.slice(0, 45) + '…' : s;
      }

      function formatTime(iso) {
        if (!iso) return '—';
        var d = new Date(iso);
        return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }) +
          '.' + String(d.getMilliseconds()).padStart(3, '0');
      }

      function formatDetails(meta) {
        if (!meta || typeof meta !== 'object') return '';
        var parts = [];
        if (meta.source) parts.push('source: ' + meta.source);
        if (meta.panel_id) parts.push('panel: ' + meta.panel_id);
        if (meta.button_id) parts.push('button: ' + meta.button_id);
        if (meta.modal_panel) parts.push('modal: ' + meta.modal_panel);
        if (meta.faq_question) parts.push('FAQ: ' + (meta.faq_question.length > 40 ? meta.faq_question.slice(0, 40) + '…' : meta.faq_question));
        if (meta.scope_item_label || meta.scope_item_id) parts.push('scope: ' + (meta.scope_item_label || meta.scope_item_id));
        if (meta.trigger) parts.push(meta.trigger);
        if (meta.to) parts.push('→ ' + meta.to);
        if (meta.star_name) parts.push('star: ' + meta.star_name);
        if (meta.seconds != null) parts.push(meta.seconds + 's');
        if (meta.video_label) parts.push(meta.video_label + (meta.pct != null ? ' ' + meta.pct + '%' : ''));
        return parts.join(' · ');
      }

      function render(events) {
        errEl.style.display = 'none';
        var filtered = filterEvents(events);
        if (filtered.length === 0) {
          tbody.innerHTML = '';
          emptyEl.style.display = 'block';
          emptyEl.textContent = events.length === 0
            ? 'No events yet. Trigger some actions on the site to see them here.'
            : getVisitorSearch() ? 'No events for that email or visitor ID (try clearing the search).' : getUtmSearch() ? 'No events for that UTM (try clearing the UTM filter).' : 'No events match the selected filters.';
          try { if (typeof updateDeleteButton === 'function') updateDeleteButton(); } catch (_) {}
          return;
        }
        emptyEl.style.display = 'none';
        tbody.innerHTML = filtered.map(function (e) {
          var details = formatDetails(e.metadata);
          var visitorDisplay = (e.visitor_email && e.visitor_email.trim()) ? e.visitor_email.trim() : (e.visitor_id || '—');
          var visitorTitle = (e.visitor_email ? e.visitor_email + (e.visitor_name ? ' (' + e.visitor_name + ')' : '') : '') + (e.visitor_id ? ' · cookie: ' + e.visitor_id : '');
          var utmStr = formatUtm(e);
          var utmTitle = [e.utm_source, e.utm_medium, e.utm_campaign, e.utm_term, e.utm_content].filter(Boolean).join(' · ') || '';
          var id = (e.id != null) ? String(e.id) : '';
          return '<tr data-event-id="' + (id ? id : '') + '">' +
            '<td class="col-sel"><input type="checkbox" class="row-select" data-event-id="' + id + '" aria-label="Select row"></td>' +
            '<td class="col-time">' + formatTime(e.occurred_at) + '</td>' +
            '<td class="col-visitor" title="' + visitorTitle + '">' + visitorDisplay + '</td>' +
            '<td class="col-type"><span class="event-type ' + (e.event_type || '') + '">' + (e.event_type || '—') + '</span></td>' +
            '<td class="col-details"><span class="details">' + (details || '—') + '</span></td>' +
            '<td class="col-utm" title="' + utmTitle + '">' + utmStr + '</td>' +
            '<td class="col-page" title="' + (e.page_url || '') + '">' + (e.page_url ? (e.page_url.replace(/^https?:\/\//, '').slice(0, 50) + (e.page_url.length > 50 ? '…' : '')) : '—') + '</td>' +
            '</tr>';
        }).join('');
        try { if (typeof updateDeleteButton === 'function') updateDeleteButton(); } catch (_) {}
      }

      function onFiltersChange() {
        render(allEvents);
      }

      function fetchEvents() {
        fetch(API + (API.indexOf('?') !== -1 ? '&' : '?') + 'limit=100')
          .then(function (r) {
            if (!r.ok) throw new Error(r.status === 401 ? 'Unauthorized (add ?view_key= to URL if required)' : r.status);
            return r.json();
          })
          .then(function (events) {
            allEvents = Array.isArray(events) ? events : [];
            render(allEvents);
          })
          .catch(function (err) {
            errEl.textContent = err.message || 'Failed to load events';
            errEl.style.display = 'block';
            tbody.innerHTML = '';
            emptyEl.style.display = 'none';
          });
      }

      document.querySelectorAll('.filters input[name="filter"]').forEach(function (cb) {
        cb.addEventListener('change', onFiltersChange);
      });
      var visitorSearchEl = document.getElementById('visitorSearch');
      if (visitorSearchEl) {
        visitorSearchEl.addEventListener('input', onFiltersChange);
        visitorSearchEl.addEventListener('keyup', onFiltersChange);
      }
      var utmSearchEl = document.getElementById('utmSearch');
      if (utmSearchEl) {
        utmSearchEl.addEventListener('input', onFiltersChange);
        utmSearchEl.addEventListener('keyup', onFiltersChange);
      }

      liveCheck.addEventListener('change', function () {
        if (refreshTimer) clearInterval(refreshTimer);
        refreshTimer = null;
        if (liveCheck.checked) refreshTimer = setInterval(fetchEvents, 5000);
      });

      var selectAllEl = document.getElementById('selectAll');
      var deleteBtn = document.getElementById('deleteSelected');

      function updateDeleteButton() {
        if (!deleteBtn) return;
        var any = tbody.querySelectorAll('input.row-select:checked').length > 0;
        deleteBtn.disabled = !any;
      }

      function onSelectAllChange() {
        var checked = selectAllEl.checked;
        tbody.querySelectorAll('input.row-select').forEach(function (cb) { cb.checked = checked; });
        updateDeleteButton();
      }

      selectAllEl.addEventListener('change', onSelectAllChange);

      tbody.addEventListener('change', function (e) {
        if (e.target && e.target.classList.contains('row-select')) updateDeleteButton();
      });

      deleteBtn.addEventListener('click', function () {
        if (deleteBtn.disabled) return;
        var idsToRemove = new Set();
        tbody.querySelectorAll('input.row-select:checked').forEach(function (cb) {
          var id = cb.getAttribute('data-event-id');
          if (id) idsToRemove.add(id);
        });
        if (idsToRemove.size === 0) return;
        allEvents = allEvents.filter(function (e) {
          return e.id == null || !idsToRemove.has(String(e.id));
        });
        render(allEvents);
        selectAllEl.checked = false;
        updateDeleteButton();
      });

      fetchEvents();
      if (liveCheck.checked) refreshTimer = setInterval(fetchEvents, 5000);
    })();
  </script>
</body>
</html>
